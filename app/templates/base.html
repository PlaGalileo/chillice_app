<!DOCTYPE html>
<html lang="es">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<head>
  <meta charset="UTF-8" />
  <title>CHILL ICE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; height: 100vh; background-color: #f5f5f5; }

    .topbar {
      position: fixed; top: 0; left: 0; width: 100%; z-index: 999;
      background-color: #0A2463; color: white; display: flex; justify-content: space-between;
      align-items: center; padding: 10px 20px; height: 60px; flex-wrap: wrap;
    }
    .topbar .left { display: flex; align-items: center; gap: 15px; }
    .topbar img.logo { height: 40px; }
    .topbar .right { display: flex; gap: 10px; align-items: center; }
    .topbar input, .topbar select { padding: 6px 10px; border-radius: 6px; border: none; }

    .main-container { display: flex; padding-top: 60px; height: calc(100vh - 60px); }
    .sidebar { background-color: #0A2463; color: white; width: 250px; transition: width 0.3s ease; display: flex; flex-direction: column; }
    .sidebar.collapsed { width: 80px; }
    .sidebar .filter-box { padding: 10px 12px; }
    .sidebar .filter-box input { width: 100%; padding: 8px; border-radius: 6px; border: none; font-size: 14px; }
    .sidebar.collapsed .filter-box { display: none; }
    .menu { flex: 1; display: flex; flex-direction: column; }
    .menu a { padding: 15px 20px; color: white; text-decoration: none; display: flex; align-items: center; gap: 12px; }
    .menu a:hover { background-color: #2C7DA0; }
    .collapsed .menu a { justify-content: center; }
    .collapsed .menu .text { display: none; }

    .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
    footer { text-align: center; font-size: 0.9em; padding: 15px; color: #777; background: #ffffff; }

    .toggle-btn { background-color: #2C7DA0; border: none; color: white; padding: 10px; font-size: 18px; cursor: pointer; border-radius: 6px; }
    .toggle-btn:hover { background-color: #1b4c7d; }

    @media (max-width: 768px) {
      .sidebar { position: fixed; height: 100%; left: -250px; top: 60px; z-index: 1000; }
      .sidebar.mobile-active { left: 0; }
      .main-container { margin-left: 0; }
    }
  </style>
</head>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="left">
      <div class="logo">
        <button class="toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      </div>
      <img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="Logo Chill Ice">
      <h1>CHILL ICE - Sistema Interno</h1>
    </div>
    <div class="right">
      <input type="text" placeholder="Buscar...">
      <select>
        <option>Filtrar por...</option>
        <option value="vigente">Vigente</option>
        <option value="vencido">Vencido</option>
      </select>
      <span><i class="fas fa-user-circle"></i> Usuario: {{ session['usuario'] }}</span>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="main-container">

    <!-- Sidebar -->
    <div class="sidebar collapsed" id="sidebar">
      <div class="filter-box">
        <input type="text" id="menu-filter" placeholder="Filtrar...">
      </div>

      <div class="menu" id="menu-links">
  <a href="{{ url_for('proyeccion.ver_proyeccion') }}"><i class="fa-solid fa-chart-line"></i><span class="text">Proyección</span></a>
  <a href="{{ url_for('lotes.registrar_lote') }}"><i class="fa-solid fa-box"></i><span class="text">Registrar Lote</span></a>
  <a href="{{ url_for('lotes.ver_lotes') }}"><i class="fa-solid fa-cubes"></i><span class="text">Ver Lotes</span></a>
  <a href="{{ url_for('cotizaciones.generar_web') }}"><i class="fa-solid fa-file-invoice"></i><span class="text">Cotizar</span></a>
  <a href="{{ url_for('ges_cotizaciones.ver_cotizaciones') }}"><i class="fa-solid fa-list"></i><span class="text">Ver Cotizaciones</span></a>
  <a href="{{ url_for('clientes.registrar_cliente') }}"><i class="fa-solid fa-user-plus"></i><span class="text">Registrar Cliente</span></a>
  <a href="{{ url_for('clientes.ver_clientes') }}"><i class="fa-solid fa-users"></i><span class="text">Ver Clientes</span></a>
  <!-- En FA6 el viejo fa-sign-out-alt ahora es fa-right-from-bracket -->
  <a href="{{ url_for('auth.logout') }}"><i class="fa-solid fa-right-from-bracket"></i><span class="text">Salir</span></a>
</div>

    </div>

    <!-- Contenido -->
    <div class="main-content">
      {% block content %}{% endblock %}
    </div>
  </div>

  <footer>
    © 2025 CHILL ICE S.A. de C.V. Todos los derechos reservados.
  </footer>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('mobile-active');
      } else {
        sidebar.classList.toggle('collapsed');
      }
    }

    document.getElementById('menu-filter').addEventListener('input', function () {
      const value = this.value.toLowerCase();
      const links = document.querySelectorAll('#menu-links a');
      links.forEach(link => {
        const text = link.textContent.toLowerCase();
        link.style.display = text.includes(value) ? 'flex' : 'none';
      });
    });

    document.addEventListener('click', function (e) {
      const sidebar = document.getElementById('sidebar');
      if (window.innerWidth <= 768 && sidebar.classList.contains('mobile-active')) {
        if (!sidebar.contains(e.target) && !e.target.closest('.toggle-btn')) {
          sidebar.classList.remove('mobile-active');
        }
      }
    });
  </script>

  <!-- Inicializador SEGURO y ÚNICO de DataTables para #tabla-cotizaciones -->
  <script>
    $(function () {
      const $t = $('#tabla-cotizaciones');
      if (!$t.length) return; // esta página no tiene la tabla

      // Crear inputs en footer SOLO si no existen aún
      if ($t.find('tfoot').length && $t.find('tfoot input').length === 0) {
        $t.find('tfoot th').each(function () {
          const title = ($(this).text() || '').trim();
          if (title) $(this).html('<input type="text" placeholder="Buscar ' + title + '" />');
        });
      }

      // Si ya está inicializada, no volver a inicializar (evita el warning)
      if ($.fn.dataTable.isDataTable($t)) {
        const dt = $t.DataTable();
        // Re-vincula filtros por si el DOM del footer se regeneró
        dt.columns().every(function () {
          const col = this;
          $('input', col.footer()).off('keyup change clear').on('keyup change clear', function () {
            if (col.search() !== this.value) col.search(this.value).draw();
          });
        });
        return;
      }

      // Inicialización única
      const table = $t.DataTable({
        responsive: true,
        retrieve: true,
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
      });

      // Filtros por columna
      table.columns().every(function () {
        const col = this;
        $('input', col.footer()).off('keyup change clear').on('keyup change clear', function () {
          if (col.search() !== this.value) col.search(this.value).draw();
        });
      });
    });
  </script>

</body>
</html>
