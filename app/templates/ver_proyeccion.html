{% extends "base.html" %}
{% block title %}Dashboard de Producci칩n{% endblock %}
{% block content %}

<style>
  :root {
    --chill-dark-blue: #0A2463; --chill-medium-blue: #2C7DA0; --chill-bg-light: #f8f9fa;
    --chill-text-dark: #343a40; --chill-border-color: #dee2e6;
  }
  .dashboard-container { font-family: "Segoe UI", system-ui, sans-serif; }
  .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
  .header-flex h2 { color: var(--chill-dark-blue); margin: 0; }
  .form-fecha { display: flex; gap: 0.5rem; align-items: center; }
  .form-fecha input, .form-fecha .btn { padding: 0.6rem 1rem; border: 1px solid var(--chill-border-color); border-radius: 8px; font-size: 1rem; }
  .btn-primary { background-color: var(--chill-medium-blue); color: white; cursor: pointer; border: none; }
  
  .kpi-controls { display: flex; gap: 0.5rem; }
  .kpi-controls .control-btn {
    background-color: var(--chill-bg-light); border: 1px solid var(--chill-border-color);
    padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer;
    color: var(--chill-medium-blue); transition: all 0.2s ease;
  }
  .kpi-controls .control-btn.active {
    background-color: var(--chill-medium-blue); color: white; border-color: var(--chill-medium-blue);
  }
  
  .dashboard-grid-top { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
  .card { background-color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .card-title { color: var(--chill-dark-blue); font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem 0; }
  .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
  .kpi-card { text-align: center; background-color: var(--chill-bg-light); padding: 1.5rem 1rem; border-radius: 10px; }
  .kpi-card .value { font-size: 2.2rem; font-weight: 700; color: var(--chill-dark-blue); }
  .kpi-card .label { font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem; }

  .pedido-card { background: var(--chill-bg-light); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
  .pedido-head { display: flex; justify-content: space-between; align-items: center; font-weight: 700; margin-bottom: 0.5rem; }
  .pedido-head a { color: var(--chill-medium-blue); text-decoration: none; }
  .pedido-items { list-style-type: none; padding-left: 1rem; color: #555; }
  .badge { font-size: 0.8em; padding: 0.3em 0.8em; border-radius: 10px; color: white; font-weight: bold; }
  .badge-nuevo { background-color: #6c757d; }
  .badge-en-proceso { background-color: #ffc107; color: black; }
  .badge-entregado { background-color: #28a745; }
  
  .graficas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  .grafica-container { text-align: center; background-color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .grafica-container h4 { margin: 0 0 1rem 0; color: var(--chill-text-dark); }
  .grafica-container img { max-width: 100%; border-radius: 8px; border: 1px solid var(--chill-border-color); }
  @media (max-width: 900px) { .graficas-grid { grid-template-columns: 1fr; } }
</style>

<div class="dashboard-container">
  <div class="header-flex">
    <h2>游늵 Dashboard de Producci칩n</h2>
    <form method="get" class="form-fecha">
      <label style="font-weight:700; color:var(--chill-text-dark);">Pedidos para el d칤a:</label>
      <input type="date" name="fecha" value="{{ fecha }}">
      <button type="submit" class="btn-primary" style="border-radius: 8px; border: none;">Buscar</button>
    </form>
  </div>

  <div class="dashboard-grid-top">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title">Indicadores Clave (KPIs)</h3>
        <div class="kpi-controls">
          <button id="btn-mensual" class="control-btn active">Mensual</button>
          <button id="btn-historico" class="control-btn">Hist칩rico</button>
        </div>
      </div>
      <div id="kpi-data-container" 
           data-ingresos-mensual="${{ '%.2f'|format(kpis.mensual.ingresos) }}"
           data-ingresos-historico="${{ '%.2f'|format(kpis.historico.ingresos) }}"
           data-conversion-mensual="{{ kpis.mensual.conversion }}"
           data-conversion-historico="{{ kpis.historico.conversion }}"
           data-bolsas-mensual="{{ kpis.mensual.bolsas5 }} / {{ kpis.mensual.bolsas15 }}"
           data-bolsas-historico="{{ kpis.historico.bolsas5 }} / {{ kpis.historico.bolsas15 }}">
        <div class="kpi-grid">
          <div class="kpi-card"><div id="kpi-ingresos" class="value">${{ '%.2f'|format(kpis.mensual.ingresos) }}</div><div class="label">Ingresos</div></div>
          <div class="kpi-card"><div id="kpi-conversion" class="value">{{ kpis.mensual.conversion }}</div><div class="label">Tasa de Conversi칩n</div></div>
          <div class="kpi-card"><div id="kpi-bolsas" class="value">{{ kpis.mensual.bolsas5 }} / {{ kpis.mensual.bolsas15 }}</div><div class="label">Bolsas 5kg / 15kg Vendidas</div></div>
          <div class="kpi-card"><div class="value">{{ kpis.stock_5kg }} / {{ kpis.stock_15kg }}</div><div class="label">Stock Actual 5kg / 15kg</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">Pedidos del D칤a ({{ fecha }})</h3>
      {% if pedidos_hoy %}{% for pedido in pedidos_hoy %}
        <div class="pedido-card">
          <div class="pedido-head">
            <a href="{{ url_for('ges_cotizaciones.detalle_cotizacion', id_cotizacion=pedido.id) }}">Pedido #{{ "%05d"|format(pedido.id) }}</a>
            <div>
              <span>{{ pedido.cliente }}</span>
              <span class="badge badge-{{ pedido.estatus|replace(' ', '-')|lower }}">{{ pedido.estatus }}</span>
            </div>
          </div>
          <ul class="pedido-items">
            {% for descripcion, cantidad in pedido.productos %}
            <li>{{ cantidad }} 칑 {{ descripcion }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}{% else %}<p>No hay pedidos programados para esta fecha.</p>{% endif %}
    </div>
  </div>
  
  <div>
    <h3 class="card-title" style="margin-left: 0.5rem; font-size: 1.5rem;">An치lisis Visual</h3>
    <div class="graficas-grid">
      <div class="grafica-container"><h4>Producci칩n vs. Entregas</h4><img src="{{ url_for('proyeccion.grafica_produccion_vs_entregas', _t=now().timestamp()) }}" alt="Gr치fica de Producci칩n vs Entregas"></div>
      <div class="grafica-container"><h4>Ingresos Mensuales</h4><img src="{{ url_for('proyeccion.grafica_ingresos_mensuales', _t=now().timestamp()) }}" alt="Gr치fica de Ingresos Mensuales"></div>
      <div class="grafica-container"><h4>Top 5 Clientes</h4><img src="{{ url_for('proyeccion.grafica_top_clientes', _t=now().timestamp()) }}" alt="Gr치fica de Top Clientes"></div>
      <div class="grafica-container"><h4>Mix de Ingresos por Producto</h4><img src="{{ url_for('proyeccion.grafica_mix_productos', _t=now().timestamp()) }}" alt="Gr치fica de Mix de Productos"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const btnMensual = document.getElementById('btn-mensual');
    const btnHistorico = document.getElementById('btn-historico');
    const container = document.getElementById('kpi-data-container');
    const kpiIngresosEl = document.getElementById('kpi-ingresos');
    const kpiConversionEl = document.getElementById('kpi-conversion');
    const kpiBolsasEl = document.getElementById('kpi-bolsas');
    btnMensual.addEventListener('click', function() {
      kpiIngresosEl.textContent = container.dataset.ingresosMensual;
      kpiConversionEl.textContent = container.dataset.conversionMensual;
      kpiBolsasEl.textContent = container.dataset.bolsasMensual;
      btnMensual.classList.add('active');
      btnHistorico.classList.remove('active');
    });
    btnHistorico.addEventListener('click', function() {
      kpiIngresosEl.textContent = container.dataset.ingresosHistorico;
      kpiConversionEl.textContent = container.dataset.conversionHistorico;
      kpiBolsasEl.textContent = container.dataset.bolsasHistorico;
      btnHistorico.classList.add('active');
      btnMensual.classList.remove('active');
    });
  });
</script>

{% endblock %}